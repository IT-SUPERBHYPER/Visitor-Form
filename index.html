<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Superb Hyper Visitor Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2870ea">
  <link rel="manifest" href="manifest.json">
  <!-- Using a data URI for the logo instead of missing file -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%232870ea'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-size='24' font-weight='bold'%3ESH%3C/text%3E%3C/svg%3E" sizes="192x192" type="image/svg+xml">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #2870ea 0%, #fff 70%, #e62739 100%);
      color: #183d5c;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 6px 32px 0 rgba(40,112,234,0.11), 0 1.5px 8px 0 rgba(40,112,234,0.07);
      max-width: 410px;
      width: 97vw;
      margin: 32px;
      padding: 36px 32px 24px 32px;
      text-align: center;
      transition: box-shadow 0.18s;
    }
    .container:focus-within, .container:hover {
      box-shadow: 0 14px 44px 0 rgba(40,112,234,0.17), 0 2.5px 15px 0 rgba(230,39,57,0.13);
    }
    .logo {
      font-size: 2rem;
      font-weight: 900;
      color: #2870ea;
      margin-bottom: 12px;
      letter-spacing: 1px;
      user-select: none;
      margin-top: 0;
    }
    .subtitle {
      font-size: 1.09rem;
      font-weight: 500;
      color: #1a2330;
      margin-bottom: 18px;
      opacity: 0.88;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 17px;
    }
    label {
      text-align: left;
      font-weight: 600;
      color: #183d5c;
      margin-bottom: 4px;
      margin-top: 2px;
      font-size: 1.01rem;
      letter-spacing: 0.01em;
      opacity: 0.98;
    }
    input, select, textarea {
      padding: 11px 12px;
      border: 1.2px solid #e2e6ef;
      border-radius: 7px;
      font-size: 1.06rem;
      outline: none;
      font-family: inherit;
      background: #f8fafc;
      transition: border 0.18s, box-shadow 0.18s;
    }
    input:focus, select:focus, textarea:focus {
      border: 1.2px solid #2870ea;
      background: #fff;
      box-shadow: 0 2px 10px #2870ea11;
    }
    button, .export-btn {
      background: #2870ea;
      color: #fff;
      border: none;
      padding: 12px 0;
      border-radius: 7px;
      font-size: 1.06rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 12px rgba(40,112,234,0.09);
      margin-top: 9px;
      transition: background 0.17s, box-shadow 0.17s, transform 0.14s;
    }
    button:hover, .export-btn:hover {
      background: #e62739;
      box-shadow: 0 4px 24px rgba(230,39,57,0.13);
      color: #fff;
      transform: translateY(-1.5px) scale(1.04);
    }
    .footer {
      margin-top: 20px;
      font-size: 0.98rem;
      color: #a0a7bc;
      user-select: none;
      opacity: 0.93;
    }
    .success {
      color: #23c181;
      background: #e8f9f3;
      border-radius: 7px;
      padding: 8px 0 4px 0;
      margin-bottom: 16px;
      font-weight: 700;
      display: none;
      font-size: 1.07rem;
      opacity: 0;
      transform: scale(0.94);
      border: 1px solid #23c18132;
      box-shadow: 0 2px 9px #23c18118;
      animation: popFade 0.56s cubic-bezier(.21,1.02,.73,1) forwards;
    }
    .success.show {
      display: block;
      animation: popFade 0.56s cubic-bezier(.21,1.02,.73,1) forwards;
    }
    @keyframes popFade {
      from { opacity: 0; transform: scale(0.9);}
      70%  { opacity: 1; transform: scale(1.06);}
      to   { opacity: 1; transform: scale(1);}
    }
    .export-buttons {
      display: flex;
      justify-content: center;
      gap: 13px;
      margin-top: 21px;
      margin-bottom: 7px;
    }
    .export-btn {
      background: #e62739;
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 7px;
      font-size: 1.01rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.13s, transform 0.13s;
      box-shadow: 0 1px 6px rgba(230,39,57,0.08);
      position: relative;
      z-index: 0;
    }
    .export-btn:hover {
      background: #2870ea;
      color: #fff;
    }
    .export-modal, .password-modal, .migration-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .export-modal-content, .password-modal-content, .migration-modal-content {
      background: white;
      border-radius: 10px;
      padding: 25px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 30px rgba(0,0,0,0.2);
    }
    .export-modal h3, .password-modal h3, .migration-modal h3 {
      margin-top: 0;
      color: #183d5c;
    }
    .date-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 20px 0;
    }
    .date-option {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .date-option input {
      width: auto;
      margin: 0;
    }
    .custom-date {
      display: none;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 7px;
    }
    .custom-date.active {
      display: flex;
    }
    .date-option input[type="date"] {
      padding: 8px;
      font-size: 0.95rem;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    .modal-btn {
      padding: 10px 20px;
      border-radius: 7px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }
    .modal-cancel {
      background: #f0f2f5;
      color: #5a6474;
    }
    .modal-export {
      background: #2870ea;
      color: white;
    }
    .modal-export:hover {
      background: #e62739;
      transform: none;
      box-shadow: none;
    }
    .password-input {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      border: 1.2px solid #e2e6ef;
      border-radius: 7px;
      font-size: 1rem;
    }
    .password-error {
      color: #e62739;
      font-size: 0.9rem;
      margin-top: 5px;
      display: none;
    }
    .migration-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 7px;
      font-weight: 600;
    }
    .migration-success {
      background: #e8f9f3;
      color: #23c181;
      display: none;
    }
    .migration-error {
      background: #fff1f0;
      color: #e62739;
      display: none;
    }
    @media (max-width: 500px) {
      .export-modal-content, .password-modal-content, .migration-modal-content {
        padding: 20px 15px;
      }
      .modal-buttons {
        flex-direction: column;
      }
      .modal-btn {
        width: 100%;
      }
    }
    @media (max-width: 500px) {
      .container { padding: 13px 2.8vw 7px 2.8vw; }
      .logo { font-size: 1.16rem; }
      .subtitle { font-size: 0.91rem; }
      input, select, textarea { font-size: 0.98rem; }
      button, .export-btn { font-size: 0.98rem; }
      .export-buttons { flex-direction: column; gap: 8px; }
    }
    /* Loading indicator */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2870ea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container" tabindex="-1">
    <div class="logo">Superb Hyper</div>
    <div class="subtitle">Visitor Registration</div>
    <div class="success" id="successMessage">Thank you for signing in. Please take a seat!</div>
    <form id="visitorForm" autocomplete="off">
      <div>
        <label for="fullName">Full Name *</label>
        <input type="text" id="fullName" name="fullName" required autofocus>
      </div>
      <div>
        <label for="company">Company / Organisation</label>
        <input type="text" id="company" name="company">
      </div>
      <div>
        <label for="purpose">Purpose of Visit *</label>
        <select id="purpose" name="purpose" required>
          <option value="">Select purpose</option>
          <option>Meeting</option>
          <option>Delivery</option>
          <option>Interview</option>
          <option>Maintenance</option>
          <option>Other</option>
        </select>
      </div>
      <div>
        <label for="contact">Contact Number *</label>
        <input type="tel" id="contact" name="contact" pattern="[0-9+\-\s]+" required>
      </div>
      <div>
        <label for="personToVisit">Person to Visit *</label>
        <input type="text" id="personToVisit" name="personToVisit" required>
      </div>
      <div>
        <label for="vehicle">Vehicle Registration</label>
        <input type="text" id="vehicle" name="vehicle">
      </div>
      <div>
        <label for="notes">Additional Notes</label>
        <textarea id="notes" name="notes" rows="2"></textarea>
      </div>
      <button type="submit" id="signInBtn">Sign In</button>
    </form>
    <div class="export-buttons">
      <button class="export-btn" id="exportCSV">Export CSV</button>
      <button class="export-btn" id="exportPDF">Export PDF</button>
    </div>
    <div class="footer">&copy; 2025 Superb Hyper — Reception</div>
  </div>
  
  <!-- Export Modal -->
  <div class="export-modal" id="exportModal">
    <div class="export-modal-content">
      <h3>Export Options</h3>
      <div class="date-options">
        <div class="date-option">
          <input type="radio" id="allTime" name="dateRange" value="all" checked>
          <label for="allTime">All Data</label>
        </div>
        <div class="date-option">
          <input type="radio" id="monthToDate" name="dateRange" value="month">
          <label for="monthToDate">Month to Date</label>
        </div>
        <div class="date-option">
          <input type="radio" id="lifeToDate" name="dateRange" value="life">
          <label for="lifeToDate">Life to Date</label>
        </div>
        <div class="date-option">
          <input type="radio" id="customRange" name="dateRange" value="custom">
          <label for="customRange">Custom Range</label>
        </div>
        <div class="custom-date" id="customDateFields">
          <label for="startDate">Start Date:</label>
          <input type="date" id="startDate">
          <label for="endDate">End Date:</label>
          <input type="date" id="endDate">
        </div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-cancel" id="cancelExport">Cancel</button>
        <button class="modal-btn modal-export" id="confirmExport">Export</button>
      </div>
    </div>
  </div>

  <!-- Password Modal -->
  <div class="password-modal" id="passwordModal">
    <div class="password-modal-content">
      <h3>Admin Authentication</h3>
      <p>Please enter the admin password to proceed with export</p>
      <input type="password" id="adminPassword" class="password-input" placeholder="Enter password">
      <div class="password-error" id="passwordError">Incorrect password. Please try again.</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-cancel" id="cancelPassword">Cancel</button>
        <button class="modal-btn modal-export" id="confirmPassword">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Migration Modal -->
  <div class="migration-modal" id="migrationModal">
    <div class="migration-modal-content">
      <h3>Data Migration</h3>
      <p>This will migrate all existing visitor data from JSONBin to Firebase.</p>
      <p><strong>Warning:</strong> This should only be done once!</p>
      <div class="migration-status migration-success" id="migrationSuccess">Migration completed successfully!</div>
      <div class="migration-status migration-error" id="migrationError">Migration failed. Please try again.</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-cancel" id="cancelMigration">Cancel</button>
        <button class="modal-btn modal-export" id="confirmMigration">Migrate Data</button>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="loading" id="loadingIndicator">
    <div class="spinner"></div>
  </div>

  <script>
    // ---- Firebase Configuration ----
    const firebaseConfig = {
      apiKey: "AIzaSyD3HcG5FIr_5hQDKOzrKuEGZNA4EQeu2HU",
      authDomain: "visitor-form-f6ae9.firebaseapp.com",
      projectId: "visitor-form-f6ae9",
      storageBucket: "visitor-form-f6ae9.firebasestorage.app",
      messagingSenderId: "140839989587",
      appId: "1:140839989587:web:63e4f2add9eeedaa0431a6",
      measurementId: "G-VLP8XN6XE6"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ---- JSONBin Configuration ----
    const API_KEY = '$2a$10$bB1IBj9WSxtFv8ueIC2FVuD60I3VYAsTardsW0hv4AiIU.KY77exu';
    const BIN_ID = '68669b0e8a456b7966babb15';
    const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}/latest`;

    // ---- South Africa Time Helper ----
    function getSouthAfricaISO() {
      const now = new Date();
      const saTime = new Date(now.getTime() + 2 * 60 * 60 * 1000);
      return (
        saTime.getUTCFullYear() + "-" +
        String(saTime.getUTCMonth() + 1).padStart(2, '0') + "-" +
        String(saTime.getUTCDate()).padStart(2, '0') + "T" +
        String(saTime.getUTCHours()).padStart(2, '0') + ":" +
        String(saTime.getUTCMinutes()).padStart(2, '0') + ":" +
        String(saTime.getUTCSeconds()).padStart(2, '0')
      );
    }

    function shortDate(iso) {
      if (!iso) return "";
      const parts = iso.split(/[-T:]/);
      if (parts.length < 6) return iso;
      const utc = Date.UTC(
        parseInt(parts[0]),
        parseInt(parts[1]) - 1,
        parseInt(parts[2]),
        parseInt(parts[3]),
        parseInt(parts[4]),
        parseInt(parts[5])
      );
      const saTime = new Date(utc + 2 * 60 * 60 * 1000);
      return (
        saTime.getUTCFullYear() + "-" +
        String(saTime.getUTCMonth() + 1).padStart(2, "0") + "-" +
        String(saTime.getUTCDate()).padStart(2, "0") + " " +
        String(saTime.getUTCHours()).padStart(2, "0") + ":" +
        String(saTime.getUTCMinutes()).padStart(2, "0")
      );
    }

    // ---- CONFIG ----
    const ADMIN_PASSWORD = 'Superb@123';
    const COLLECTION_NAME = 'visitors';

    // Show loading indicator
    function showLoading() {
      document.getElementById('loadingIndicator').style.display = 'flex';
    }

    // Hide loading indicator
    function hideLoading() {
      document.getElementById('loadingIndicator').style.display = 'none';
    }

    // ---- DATE FILTERING ----
    function filterDataByRange(data, rangeType, startDate = null, endDate = null) {
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const startOfYear = new Date(now.getFullYear(), 0, 1);
      
      return data.filter(entry => {
        if (!entry.timestamp) return false;
        const entryDate = new Date(entry.timestamp);
        
        switch(rangeType) {
          case 'month':
            return entryDate >= startOfMonth;
          case 'life':
            return entryDate >= startOfYear;
          case 'custom':
            if (!startDate || !endDate) return true;
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            return entryDate >= start && entryDate <= end;
          default:
            return true;
        }
      });
    }

    // ---- EXPORT FUNCTIONS ----
    function exportToCSV(data) {
      const fields = ["timestamp","fullName", "company", "purpose", "contact", "personToVisit", "vehicle", "notes"];
      const csv = [
        fields.map(f => `"${f.replace(/"/g, '""')}"`).join(","),
        ...data.map(row =>
          fields.map(field => {
            let value = row[field] || "";
            if (field === "timestamp") {
              value = shortDate(value);
            }
            return `"${value.toString().replace(/"/g, '""')}"`;
          }).join(",")
        )
      ].join("\r\n");

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `superb_visitors_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportToPDF(data) {
      const fields = ["timestamp", "fullName", "company", "purpose", "contact", "personToVisit", "vehicle", "notes"];
      const fieldNames = ["Date/Time", "Full Name", "Company", "Purpose", "Contact", "Person to Visit", "Vehicle", "Notes"];
      const rows = data.map(row => [
          shortDate(row.timestamp),
          row.fullName || "",
          row.company || "",
          row.purpose || "",
          row.contact || "",
          row.personToVisit || "",
          row.vehicle || "",
          row.notes || ""
      ]);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape" });
      const pageWidth = doc.internal.pageSize.getWidth();
      doc.setFontSize(16);
      doc.text("Superb Hyper - Visitor Log", pageWidth/2, 14, { align: "center" });
      doc.setFontSize(10);

      doc.autoTable({
        head: [fieldNames],
        body: rows,
        startY: 22,
        theme: 'grid',
        styles: {
          fontSize: 8,
          cellPadding: 1,
          overflow: 'linebreak',
          valign: 'top'
        },
        columnStyles: {
            0: { cellWidth: 38 },
            1: { cellWidth: 38 },
            2: { cellWidth: 36 },
            3: { cellWidth: 30 },
            4: { cellWidth: 34 },
            5: { cellWidth: 40 },
            6: { cellWidth: 33 },
            7: { cellWidth: 48 }
        },
        headStyles: {
            fillColor: [40, 112, 234],
            textColor: [255, 255, 255],
            fontStyle: 'bold'
        },
        alternateRowStyles: {
            fillColor: [248, 250, 252]
        }
      });

      doc.save(`superb_visitors_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    // ---- FIRESTORE OPERATIONS ----
    async function saveVisitorData(data) {
      try {
        const docRef = await db.collection(COLLECTION_NAME).add(data);
        console.log("Document written with ID: ", docRef.id);
        return true;
      } catch (error) {
        console.error("Error adding document: ", error);
        return false;
      }
    }

    async function fetchAllVisitors() {
      try {
        const snapshot = await db.collection(COLLECTION_NAME).orderBy('timestamp', 'desc').get();
        const visitors = [];
        snapshot.forEach(doc => {
          visitors.push({ id: doc.id, ...doc.data() });
        });
        return visitors;
      } catch (error) {
        console.error("Error getting documents: ", error);
        return [];
      }
    }

    // ---- JSONBIN OPERATIONS ----
    async function fetchJsonBinData() {
      try {
        const res = await fetch(API_URL, {
          headers: { "X-Master-Key": API_KEY }
        });
        if (res.ok) {
          const json = await res.json();
          return Array.isArray(json.record) ? json.record : [];
        } else {
          console.warn('JSONBin request failed:', res.status, res.statusText);
          return [];
        }
      } catch (err) {
        console.error('Network error fetching JSONBin data:', err);
        return [];
      }
    }

    // ---- MIGRATION FUNCTION ----
    async function migrateData() {
      showLoading();
      try {
        // Fetch data from JSONBin
        const jsonData = await fetchJsonBinData();
        if (jsonData.length === 0) {
          document.getElementById('migrationError').textContent = 'No data found in JSONBin to migrate.';
          document.getElementById('migrationError').style.display = 'block';
          document.getElementById('migrationSuccess').style.display = 'none';
          return;
        }

        // Check if data already exists in Firebase
        const firebaseData = await fetchAllVisitors();
        if (firebaseData.length > 0) {
          // Ask for confirmation if data already exists
          const confirm = window.confirm(`There are already ${firebaseData.length} records in Firebase. Do you want to proceed with migration? This may create duplicates.`);
          if (!confirm) {
            hideLoading();
            return;
          }
        }

        // Migrate data to Firebase
        const batchSize = 10; // Process in batches to avoid timeouts
        let successCount = 0;
        let errorCount = 0;

        for (let i = 0; i < jsonData.length; i += batchSize) {
          const batch = jsonData.slice(i, i + batchSize);
          const promises = batch.map(item => saveVisitorData(item));
          const results = await Promise.all(promises);
          
          successCount += results.filter(r => r).length;
          errorCount += results.filter(r => !r).length;
        }

        if (errorCount === 0) {
          document.getElementById('migrationSuccess').style.display = 'block';
          document.getElementById('migrationError').style.display = 'none';
        } else {
          document.getElementById('migrationError').textContent = `Migration completed with ${errorCount} errors. ${successCount} records migrated successfully.`;
          document.getElementById('migrationError').style.display = 'block';
          document.getElementById('migrationSuccess').style.display = 'none';
        }
      } catch (error) {
        console.error("Migration error:", error);
        document.getElementById('migrationError').textContent = 'Migration failed: ' + error.message;
        document.getElementById('migrationError').style.display = 'block';
        document.getElementById('migrationSuccess').style.display = 'none';
      } finally {
        hideLoading();
      }
    }

    // ---- EVENT HANDLERS ----
    document.addEventListener('DOMContentLoaded', function() {
      // Add migration button to footer for admin access
      const footer = document.querySelector('.footer');
      const migrationLink = document.createElement('div');
      migrationLink.innerHTML = '<button class="export-btn" style="margin-top:10px;font-size:0.85rem;padding:6px 12px;" id="migrateData">Migrate Data</button>';
      footer.parentNode.insertBefore(migrationLink, footer.nextSibling);

      // Form submission
      document.getElementById('visitorForm').onsubmit = async function(e) {
        e.preventDefault();
        const form = e.target;
        const data = {
          fullName: form.fullName.value,
          company: form.company.value,
          purpose: form.purpose.value,
          contact: form.contact.value,
          personToVisit: form.personToVisit.value,
          vehicle: form.vehicle.value,
          notes: form.notes.value,
          timestamp: getSouthAfricaISO()
        };

        showLoading();
        try {
          const success = await saveVisitorData(data);
          if (success) {
            form.reset();
            const successMsg = document.getElementById('successMessage');
            successMsg.classList.add('show');
            setTimeout(() => {
              successMsg.classList.remove('show');
            }, 3200);
          } else {
            alert("Error saving your details. Please try again.");
          }
        } catch (error) {
          console.error("Submission error:", error);
          alert("Error saving your details. Please try again.");
        } finally {
          hideLoading();
        }
      };

      // ---- MODAL ELEMENTS ----
      const exportModal = document.getElementById('exportModal');
      const passwordModal = document.getElementById('passwordModal');
      const migrationModal = document.getElementById('migrationModal');
      const customDateFields = document.getElementById('customDateFields');
      const passwordError = document.getElementById('passwordError');
      const adminPasswordInput = document.getElementById('adminPassword');
      
      // ---- PASSWORD PROTECTION ----
      let exportFormat = '';
      
      // Show password modal when export is initiated
      document.getElementById('exportCSV').onclick = () => {
        exportFormat = 'csv';
        passwordModal.style.display = 'flex';
        adminPasswordInput.value = '';
        passwordError.style.display = 'none';
        adminPasswordInput.focus();
      };
      
      document.getElementById('exportPDF').onclick = () => {
        exportFormat = 'pdf';
        passwordModal.style.display = 'flex';
        adminPasswordInput.value = '';
        passwordError.style.display = 'none';
        adminPasswordInput.focus();
      };
      
      // Handle password confirmation
      document.getElementById('confirmPassword').onclick = async () => {
        const enteredPassword = adminPasswordInput.value;
        if (enteredPassword === ADMIN_PASSWORD) {
          passwordModal.style.display = 'none';
          exportModal.style.display = 'flex';
        } else {
          passwordError.style.display = 'block';
          adminPasswordInput.value = '';
          adminPasswordInput.focus();
        }
      };
      
      // Cancel password modal
      document.getElementById('cancelPassword').onclick = () => {
        passwordModal.style.display = 'none';
      };
      
      // Allow Enter key in password field
      adminPasswordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('confirmPassword').click();
        }
      });
      
      // ---- DATE RANGE OPTIONS ----
      document.getElementById('customRange').onchange = () => {
        customDateFields.classList.add('active');
        // Set default dates to current month
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('startDate').valueAsDate = firstDay;
        document.getElementById('endDate').valueAsDate = today;
      };
      
      document.querySelectorAll('input[name="dateRange"]').forEach(input => {
        if (input.value !== 'custom') {
          input.onchange = () => {
            customDateFields.classList.remove('active');
          };
        }
      });

      // ---- EXPORT CONFIRMATION ----
      document.getElementById('confirmExport').onclick = async () => {
        const selectedRange = document.querySelector('input[name="dateRange"]:checked').value;
        let startDate = null;
        let endDate = null;
        
        if (selectedRange === 'custom') {
          startDate = document.getElementById('startDate').value;
          endDate = document.getElementById('endDate').value;
          if (!startDate || !endDate) {
            alert('Please select both start and end dates');
            return;
          }
        }
        
        showLoading();
        try {
          const data = await fetchAllVisitors();
          const filteredData = filterDataByRange(data, selectedRange, startDate, endDate);
          
          if (filteredData.length === 0) {
            alert("No visitor records match the selected criteria.");
            hideLoading();
            return;
          }
          
          // Export based on format
          if (exportFormat === 'csv') {
            exportToCSV(filteredData);
          } else {
            exportToPDF(filteredData);
          }
          
          exportModal.style.display = 'none';
        } catch (error) {
          console.error("Export error:", error);
          alert("Error exporting data. Please try again.");
        } finally {
          hideLoading();
        }
      };

      // ---- MODAL CANCEL BUTTONS ----
      document.getElementById('cancelExport').onclick = () => {
        exportModal.style.display = 'none';
      };

      // ---- MIGRATION MODAL ----
      document.getElementById('migrateData').onclick = () => {
        migrationModal.style.display = 'flex';
        document.getElementById('migrationSuccess').style.display = 'none';
        document.getElementById('migrationError').style.display = 'none';
      };

      document.getElementById('confirmMigration').onclick = async () => {
        await migrateData();
      };

      document.getElementById('cancelMigration').onclick = () => {
        migrationModal.style.display = 'none';
      };

      // Close modals when clicking outside
      window.onclick = function(event) {
        if (event.target === exportModal) {
          exportModal.style.display = 'none';
        }
        if (event.target === passwordModal) {
          passwordModal.style.display = 'none';
        }
        if (event.target === migrationModal) {
          migrationModal.style.display = 'none';
        }
      };
    });

    // ---- Register service worker for PWA ----
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // Check if service-worker.js exists before trying to register it
        fetch('service-worker.js', { method: 'HEAD' })
          .then(response => {
            if (response.ok) {
              navigator.serviceWorker.register('service-worker.js');
            } else {
              console.log('Service worker file not found, skipping registration');
            }
          })
          .catch(error => {
            console.log('Error checking for service worker:', error);
          });
      });
    }
  </script>
</body>       
</html>